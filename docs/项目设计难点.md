# 项目设计难点🔮

## 1️⃣难点一：SSVEP刺激器的设计

刺激器作为本项目的重点设计以及创新部分，首先在设计过程中刺激频率的选取就至关重要，由于谐波成分的存在，要尽量**避免一个刺激频率是另一个刺激频率的整数倍**，否则将容易引起识别错误的情况。为此我们选取的频率范围为8.0`Hz`-15.4`Hz`，同时考虑到项目中刺激目标的数量，为了能够实现指令的丰富性，提高使用的体验，团队在借鉴国内外多种方法与经验的基础上，采用**正弦频率相位联合调制**（`JPFM`）的方法，相比以往单一的黑白两色闪烁，采用正弦调制的方法，可以增加闪烁刺激的目标数，并且可以在屏幕刷新率允许的范围内，实现任意频率的闪烁刺激。这样既避免了使用者注视某一特定闪烁块时相邻闪烁块对其造成的干扰，又能实现任意频率的闪烁刺激，这大大提高了设备的适用性，对于不同的使用者，只需在佩戴后进行一定的校准训练即可。**最终我们设计的`SSVEP`拼写器设计频率为8.0`Hz`-15.4`Hz`，相位为0-2$\pi$，共38个目标数。两个刺激块的频率差为0.2`Hz`，相位差为0.5$\pi$**，经过我们的测试，使用`JPFM`的刺激器可以提高注意力检测速度和准确性。

## 2️⃣难点二：数据预处理

脑电信号经过脑电帽采集放大后，会携带有伪迹干扰，常见的伪迹干扰有生理性伪迹和物理性伪迹，如果不能去除这些伪迹得到真正的脑电信号，那么识别准确率会大大降低。为了消除这些杂波的干扰，我们先进行了**去基线漂移，提高信号的准确度；然后采用50`Hz`陷波器，滤除工频干扰；最后进行4-90`Hz`的带通滤波**，就可以到的准确的脑电信号，从而完成预处理。

## 3️⃣难点三：利用OPENBCI在线分析

由于项目需要进行在线分析，所以重点要进行数据流的实时传输。考虑到能力有限，我们选取了第三方开源的脑电采集显示传输的软件-`OpenBCI`，其作为一种强大的软件工具，用于可视化、记录和流式传输来自` OpenBCI `板的数据。数据可以实时显示、回放、以 `.txt` 格式保存到您的计算机，以及实时流式传输到 `MATLAB` 等第三方软件。

通过其内部的`LSL`组件，将数据流发送给`MATLAB`后，我们先对其**进行预处理，然后对其进行FFT变换获得其频谱特征**，理论上获取频谱特征后就可以判断出刺激频率，但为了提高准确度，**我们还采用的`CCA`来计算多通道`SSVEP`和对应于每个刺激频率的参考信号之间的规范相关性**。具有最大相关性的参考信号的频率被认为是`SSVEP`的频率。团队在原有`CCA`算法的基础上，**结合矩阵向量空间对八个脑电采集通道进行加权处理，即对八通道分配不同的权重**，以此来达到更好信号匹配效果。经最终测试，此种改进算法的识别准确度在76.3%左右，相关系数达0.8以上。

在本项目中，还可以采用深度学习进行数据处理。我们采用已有的数据集分为3个部分，5000个数据作为训练集，5000个数深度学习的方法来处理脑波对车的控制问题。**深度学习有三个关键部分，数据集，算法，算力**。在数据集上，我们将据作为验证集，1000个数据作为测试集，防止数据使用重复次数太多而导致模型预测出结果不够精准。**在算法上，在这里只做一个简述，首先这是一个逻辑回归问题，波形输入以后，利用卷积层对波形进行特征提取，然后进行降维操作**，最后将波形通过全连接网络经过`sigmoid`激活函数将其进行分类，达到训练的目的。算力方面，由于本模型使用的数据集并不是特别庞大，本机的`GPU`可以完成加速任务。总体思路就是首先我们将传感器的采集到的脑波做预处理，去掉大部分的杂波，将过滤的信号输入到我们已经训练好的模型中，让模型对其作出预测，从而对系统进行更好的控制。

## 4️⃣难点四：智能车（机器人）的设计

智能车作为本项目中重要的指令执行设备，本项目不仅局限于脑电控制移动，还设计了基于智能机器人的机器视觉+自主跟随部分方案，在运用机器视觉完成自动抓取物体和自主跟随部分，采用的是一个开源的机器视觉模块` openmv`，以 `STM32F427`为核心，集成了` OV7725` 摄像头芯片，用 `C`语言高效地实现了核心机器视觉算法，并且提供` Python `编程接口，使用者可以用` Python` 语言对 `OpenMV` 提供的机器视觉功能进行编程。它可以通过 `UART，I2C，SPI，AsyncSerial `以及` GPIO` 等控制其他的硬件，甚至是单片机模块，如 `Arduino`、`RaspberryPi `等。它也可以被其他的单片机模块控制。

在完成整个作品的过程中，涉及的图像基本过滤算法主要包括：帧间差分； 二值化；边缘阈值检测；腐蚀和膨胀；平均、中值、中点滤波；锐化等。合理的使用这些过滤算法可以完成许多例如颜色识别，色块识别，甚至是轨迹识别、人脸识别等。

为了实现现实中的例如对病人的实时跟踪，对待抓取物品的距离测定，对待抓取物品的角度和倾斜度的测量，我们采用了较为成熟的 `AprilTag` 标记追踪。`AprilTag `是一个由密歇根州立大学的 April 实验室开发的、免费开源的视觉定位系统，该技术利用类似于二维码的` Tag `实现定位，被广泛应用于机器人、无人机定位导引等。

对于脑电波控制，我们考虑到脑电波的精确度，采用` Openmv `对药品包装的颜色和药品名称进行识别与抓取。首先我们先采样一幅目标图片并且将图像的`LAB `值提取出来，在 `python` 代码中设置相关的阈值通过对药品包装的 `LAB` 特征值进行对比和存储，并且测量出目标的宽度和距离信息，以便于通过` stm32 `处理后交付机械臂进行抓取。
