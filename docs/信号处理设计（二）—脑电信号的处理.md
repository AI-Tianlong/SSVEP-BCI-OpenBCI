# ä¿¡å·å¤„ç†è®¾è®¡ï¼ˆäºŒï¼‰â€”è„‘ç”µä¿¡å·çš„å¤„ç†ï¼ˆä»£ç åˆ†æï¼‰ğŸ«‚

## ğŸ§Ÿâ€â™‚ï¸SSVEPå¯¹äºåˆºæ¿€é¢‘ç‡çš„è¦æ±‚

è¯±å‘SSVEPä¿¡å·æ—¶å¯¹åˆºæ¿€æºæœ‰ä¸€å®šçš„è¦æ±‚ï¼Œåœ¨é’ˆå¯¹SSVEPä¿¡å·çš„ç°å®å·¥ç¨‹åº”ç”¨ä¸­è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

* èƒ½è¯±å‘`SSVEP`å¹…åº¦éšé¢‘ç‡å˜åŒ–çš„å“åº”æ›²çº¿å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªåŒºåŸŸ:**ä½é¢‘åŒº(4~15Hz)**, ä¸­é¢‘åŒº(15~30Hz), é«˜é¢‘åŒº(30~60Hz)ã€‚ä¸ç¨³å®šçš„é¢‘ç‡æ—  æ³•è¯±å‘ç¨³å®šçš„`SSVEP`ä¿¡å·ï¼Œå°†ä¸¥é‡å½±å“å¯¹ä¿¡å·è¯†åˆ«çš„å‡†ç¡®ç‡ï¼Œå› æ­¤ç¨³å®šçš„åˆºæ¿€é¢‘ç‡æ˜¯å¿…é¡»çš„ã€‚

* ä¸åŒäººçš„`SSVEP`ä¿¡å·å¹…å€¼ä¸å°½ç›¸åŒï¼Œå¯¹ç›¸åŒé¢‘ç‡çš„å“åº”æ•æ„Ÿç¨‹åº¦ä¹Ÿå­˜åœ¨å·®å¼‚ï¼ŒåŒæ—¶ï¼Œç”±äºè°æ³¢æˆåˆ†çš„å­˜åœ¨ï¼Œ**è¦å°½é‡é¿å…ä¸€ä¸ªåˆºæ¿€é¢‘ç‡æ˜¯å¦ä¸€ä¸ªåˆºæ¿€é¢‘ç‡çš„æ•´æ•°å€**ï¼Œå¦åˆ™å°†å®¹æ˜“å¼•èµ·è¯†åˆ«é”™è¯¯çš„æƒ…å†µã€‚

* è¯±å‘`SSVEP`ä¿¡å·çš„åˆºæ¿€æºè¦å…·æœ‰å‹å¥½æ€§ï¼Œæ»¡è¶³å—è¯•è€…å¯¹äºèˆ’é€‚æ€§çš„è¦æ±‚ï¼Œåˆºæ¿€é¢‘ç‡è¿‡é«˜æˆ–æ˜¯åˆºæ¿€å¼ºåº¦è¿‡å¤§å®¹æ˜“å¯¼è‡´è§†è§‰ç–²åŠ³è€Œå½±å“è§†åŠ›å¥åº·ï¼Œç”šè‡³ä¼šè¯±å‘ç™«ç—«æ ·è„‘ç”µæ´»åŠ¨ã€‚

## ğŸ§Œè„‘ç”µä¿¡å·çš„å¹²æ‰°

å…³äºè„‘ç”µä¿¡å·çš„å¹²æ‰°å¯ä»¥å‚è€ƒï¼šğŸ‘‡ğŸ‘‡ğŸ‘‡

ğŸ¥³[è„‘ç”µä¿¡å·å¹²æ‰° (qq.com)](https://mp.weixin.qq.com/s?__biz=Mzg4MzYzNDgwMQ==&mid=2247508104&idx=1&sn=fff5ae49cd5cc568bf668819c19887f7&source=41#wechat_redirect)

* æ ¹æ®å¹³æ—¶å®éªŒçš„è§‚å¯Ÿï¼Œ**è¿åŠ¨ä¼ªè¿¹å¯¹è„‘ç”µä¿¡å·äº§ç”Ÿçš„å¹²æ‰°éå¸¸å¤§ï¼ï¼ï¼**ï¼Œæ‰€ä»¥åšå®éªŒçš„æ—¶å€™å¤´ä¸è¦åŠ¨ï¼
* å·¥é¢‘å¹²æ‰°ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œæ ¹æ®å¹³æ—¶åšå®éªŒæ¥çœ‹ï¼Œ**ç›´æ¥å°±èƒ½åœ¨é¢‘è°±ä¸Šçœ‹åˆ°ä¸€ä¸ªå¾ˆå¤§çš„50Hzçš„æˆåˆ†**ã€‚

## ğŸŒˆè„‘ç”µä¿¡å·çš„å¤„ç†

ä½¿ç”¨é™„åŠ è„‘ç”µä¿¡å·æ”¾å¤§å™¨çš„å…«é€šé“çš„è„‘ç”µé‡‡é›†å¸½å¯¹ `P03ã€P0Zã€P04ã€O1ã€OZã€O2 `å…­ä¸ªç”µæä½ç½®è¿›è¡Œè„‘ç”µé‡‡é›†ï¼Œå¹¶ç»æ”¾å¤§å™¨æ”¾å¤§åï¼Œå®æ—¶ä¼ è¾“ `LSL `è„‘ç”µæ•°æ®æµåˆ° `MATLAB` ä¸­è¿›è¡Œ åˆ†æï¼Œä»¥ `250 Hz` è¿›è¡Œé‡‡æ ·ï¼Œå»é™¤åŸºçº¿æ¼‚ç§»åï¼Œé‡‡ç”¨ `50 Hz` é™·æ³¢å™¨æ»¤é™¤å·¥é¢‘å¹²æ‰°ï¼Œç„¶åè¿›è¡Œ` 4ï½90`Hz çš„å¸¦é€šæ»¤æ³¢ï¼Œæœ€åè¿›è¡Œå¿«é€Ÿå‚…é‡Œå¶å˜æ¢ã€‚

**çœ‹æˆ‘çœ‹æˆ‘çœ‹æˆ‘**â—â—â—ğŸ²ğŸ²ğŸ²ï¼š

éœ€è¦æå‰è¯´æ˜çš„æ˜¯ï¼šåœ¨[SSVEP-BCI-OpenBCI/matlab_signal_processing at main Â· AI-Tianlong/SSVEP-BCI-OpenBCI Â· GitHub](https://github.com/AI-Tianlong/SSVEP-BCI-OpenBCI/tree/main/matlab_signal_processing)æˆ‘ä»¬æä¾›äº†è¯¦ç»†çš„ä»£ç æ³¨é‡Šï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä¸åœ¨ç´¯èµ˜ï¼Œä¼šæœ‰é’ˆå¯¹æ€§çš„è®²è§£ä¸€äº›éœ€è¦æ³¨æ„çš„åœ°æ–¹ã€‚

***

**å¦‚æœæ˜¯åœ¨çº¿å®æ—¶åˆ†æï¼Œé‚£ä¹ˆå°±æ²¡æœ‰å¯¹å¤„ç†å¥½çš„Nä¸ªäººçš„æ•°æ®å–å¹³å‡äº†**â—â—â—

```mermaid
graph LR
RAWæ•°æ® ==> å»é™¤åŸºçº¿æ¼‚ç§» ==> 50Hzé™·æ³¢æ»¤æ³¢ ==> 4-90Hzå¸¦é€šæ»¤æ³¢ ==> å¯¹å¤„ç†å¥½çš„Næ¬¡trialæ•°æ®å–å¹³å‡ ==>FFT
```

### å…³äºoffline_analysisä»£ç 

`offline_analysis`ä»£ç å‚è€ƒçš„æ˜¯`title={An Open Dataset for Wearable SSVEP-Based Brain-Computer Interfaces}`è¿™ç¯‡è®ºæ–‡ï¼Œåœ¨[**EEG_RAW_data**](https://github.com/AI-Tianlong/SSVEP-BCI-OpenBCI/tree/main/matlab_signal_processing/EEG_RAW_data)å¯ä»¥æ‰¾åˆ°**ç›¸å…³çš„æ•°æ®ä»¥åŠè®ºæ–‡ä¿¡æ¯**ã€‚åŸæ–‡æµè§ˆä»¥åŠå®Œæ•´æ•°æ®é›†ä¸‹è½½å¦‚ä¸‹ğŸ‘‡ğŸ‘‡ğŸ‘‡

[Sensors | Free Full-Text | An Open Dataset for Wearable SSVEP-Based Brain-Computer Interfaces (mdpi.com)](https://www.mdpi.com/1424-8220/21/4/1256)

[æ¸…åå¤§å­¦è„‘æœºæ¥å£ç ”ç©¶ç»„ (tsinghua.edu.cn)](http://bci.med.tsinghua.edu.cn/download.html)

[A Benchmark Dataset for SSVEP-Based Brainâ€“Computer Interfaces | IEEE Journals & Magazine | IEEE Xplore](https://ieeexplore.ieee.org/document/7740878)

***

#### **1.å…³äºè¿™ä¸ª5-DçŸ©é˜µçš„é—®é¢˜**

```matlab
DATA1 = mean(squeeze(data(6,:,2,:,7)),2)';
    %å‚è€ƒçš„æ˜¯é‚£ç¯‡è®ºæ–‡é‡Œé¢çš„ï¼šAn Open Dataset for Wearable SSVEP-BasedBrain-Computer Interfaces
    %ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºé€šé“ï¼Œç¬¬äºŒä¸ªä¸ºé‡‡æ ·çš„æ•°æ®ï¼Œç¬¬ä¸‰ä¸ªæ˜¯å¹²ç”µææˆ–è€…æ˜¯æ¹¿ç”µæï¼Œç¬¬å››ä¸ªæ˜¯ä¸€ä¸ªäººçš„å®éªŒæ¬¡æ•°(trial)ï¼Œç¬¬äº”ä¸ªæ˜¯è‰²å—çš„é¢‘ç‡å¯¹åº”(åœ¨information pdfé‡Œé¢)
```

***

#### 2.å»åŸºçº¿æ¼‚ç§»ä¸­çš„é—®é¢˜ï¼š

```matlab
fs=250;%é‡‡æ ·é¢‘ç‡ï¼Œå¯ä»è½¯ä»¶ä¸Šè®¾å®š
Ts=1/fs;%æ—¶é—´é—´éš”ä¸ºé‡‡æ ·é¢‘ç‡çš„å€’æ•°
fmaxd=3;%æˆªæ­¢é¢‘ç‡ä¸º3Hz
fmaxn=fmaxd/(fs/2);%ç‰¹å®šå†™æ³•ï¼Œå¥½åƒæ˜¯æ•°å­—è¿˜æ˜¯æ¨¡æ‹Ÿè§’é¢‘ç‡ï¼Œå¿…é¡»ç”¨è¿™ä¸ªæ¥å¸¦å…¥butterå‡½æ•°
[b,a]=butter(1,fmaxn,'low');%è¿™ä¸€æ­¥æ˜¯è·å¾—bï¼Œaè¿™ä¿©å‚æ•°
data_3Hz = filtfilt(b,a,sig_raw);%é€šè¿‡3Hzä½é€šæ»¤æ³¢å™¨çš„ä¿¡å·
sig_after_detrend = sig_raw - data_3Hz; %å»é™¤è¿™ä¸€æ®µä¿¡å·ï¼Œå¾—åˆ°å»åŸºçº¿æ¼‚ç§»çš„ä¿¡å·
```

è„‘ç”µä¿¡å·ä¸»è¦é›†ä¸­åœ¨ä½é¢‘æ®µï¼Œå…³äºå¦‚ä½•é€‰å–è¿™ä¸ªæˆªæ­¢é¢‘ç‡ï¼Œéœ€è¦åæœŸå†çœ‹æ›´å¤šçš„èµ„æ–™æ¥è¿›è¡Œé€‰æ‹©

å…³äºä¸ºä»€ä¹ˆç”¨è¿™ä¸ªåŠæ³•ï¼Œçœ‹è¿™ä¸ªåšå®¢ğŸ‘‡ğŸ‘‡ğŸ‘‡

[é«˜é€šæ»¤æ³¢å»é™¤åŸºçº¿æ¼‚ç§»matlab,å»åŸºçº¿æ¼‚ç§»_é’Ÿå®‡è…¾çš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/weixin_35559202/article/details/116109701)

***

#### 3.å…³äº50Hzé™·æ³¢æ»¤æ³¢çš„é—®é¢˜

ç¬¬ä¸€ç§æ–¹æ³•ï¼š

```matlab
%% 50Hz é™·æ³¢æ»¤æ³¢
%è¿™é‡Œä½¿ç”¨äº†Brainflowçš„ä¿¡å·å¤„ç†åº“,è¯·è‡ªå·±æ›´æ¢é™·æ³¢æ»¤æ³¢å™¨æˆ–æ·»åŠ Brainflowåº“äºmatlabè·¯å¾„ä¸­
%è¯¦æƒ…ä½¿ç”¨æ–¹æ³•å¯ä»¥å‚è€ƒ https://brainflow.readthedocs.io/en/stable/BuildBrainFlow.html#matlab

sig_after_notch = DataFilter.perform_bandstop(sig_after_detrend, 250, 50, 2, 3, 0, 0.2);  %50Hzå·¥é¢‘çš„å¸¦é˜»
```

è¿™é‡Œä½¿ç”¨çš„æ˜¯`Brainflow`é‡Œé¢è‡ªå¸¦çš„åº“å‡½æ•°è¿›è¡Œé™·æ³¢æ»¤æ³¢å™¨è®¾ç½®ï¼Œè‡³äºæ‹¬å·å†…çš„å‚æ•°ï¼šå…³äº`order`ã€`filter_type`å’Œ`ripple`ï¼Œä¸€å¾‹ä¸ºé»˜è®¤å€¼ï¼ˆæ‹¬å·å†…çš„å€¼å°±æ˜¯é»˜è®¤å€¼ï¼‰

![image-20230112201958510](https://cdn.jsdelivr.net/gh/Bu0717/image/imgimage-20230112201958510.png)

å…³äº`Brainflow`çš„å®‰è£…å¯ä»¥å‚è€ƒå®˜æ–¹ç½‘ç«™[Installation Instructions â€” BrainFlow documentation](https://brainflow.readthedocs.io/en/stable/BuildBrainFlow.html#matlab)

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå»ºè®®æå‰å‡†å¤‡å¥½`VS2017`ä»¥ä¸Šç‰ˆæœ¬ï¼Œè¿™ç‚¹åœ¨æ–‡æ¡£ä¸­å·²ç»æå‡ºï¼Œå®‰è£…å®Œæˆåä¸€å®šè¦æ·»åŠ åˆ°matlabè·¯å¾„ã€‚å¦‚æœæŒ‰ç…§æ–‡æ¡£é…ç½®å¤šæ¬¡ï¼Œä»ç„¶æŠ¥é”™ï¼Œè¿™é‡Œå»ºè®®ä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•ğŸ˜¶â€ğŸŒ«ï¸ğŸ˜¶â€ğŸŒ«ï¸ğŸ˜¶â€ğŸŒ«ï¸

![image-20230112202809385](https://cdn.jsdelivr.net/gh/Bu0717/image/imgimage-20230112202809385.png)

![image-20230112202832884](https://cdn.jsdelivr.net/gh/Bu0717/image/imgimage-20230112202832884.png)

![image-20230112202921086](https://cdn.jsdelivr.net/gh/Bu0717/image/imgimage-20230112202921086.png)

***

ç¬¬äºŒç§æ–¹æ³•ï¼š

ä½¿ç”¨æˆ‘ä»¬è‡ªå·±è®¾è®¡çš„é™·æ³¢æ»¤æ³¢å™¨è¿›è¡Œå¤„ç†ï¼Œå¯å‚è€ƒ[matlab é™·æ³¢å™¨,50Hzé™·æ³¢å™¨(Matlabç¨‹åº)_yueyuzçš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/weixin_42360722/article/details/115815278?ops_request_misc={"request_id"%3A"164903344816780255292662"%2C"scm"%3A"20140713.130102334.pc_blog."}&request_id=164903344816780255292662&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-4-115815278.article_score_rank_blog&utm_term=50hzé™·æ³¢å™¨&spm=1018.2226.3001.4450)

æ»¤æ³¢å™¨çš„å¤„ç†å‡½æ•°åœ¨`test2`ä¸­ï¼Œæœ€é‡è¦çš„ä¸€ä¸ª`dlsim`å‡½æ•°ï¼Œä¹Ÿæ˜¯ä½¿ç”¨çš„`matlab`è‡ªå¸¦çš„ï¼Œæ‰€ä»¥ç›¸å½“äºæˆ‘ä»¬åªæ˜¯è®¾è®¡äº†ä¸€ä¸‹å‚æ•°

ä½†æ˜¯ï¼Œè¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸¤è€…å¯ä»¥ç”¨æ¥è¿›è¡Œå¯¹æ¯”ï¼ŒäºŒè€…åœ¨æ˜¾ç¤ºä¸Šå¹¶æ²¡æœ‰ä»€ä¹ˆå·®åˆ«ï¼Œè¿™å¯ä»¥ä½œä¸ºä¸€ä¸ªå¯¹æ¯”ç‚¹ã€‚

```matlab
function [result]=test2(sig_after_detrend, fs, f0)
    %è®¾ç½®åˆå€¼
    f0=f0;
    fs=fs;
    Ts=1/fs;
    NLen=512;
    n=0:NLen-1;
    %é™·æ³¢å™¨çš„è®¾è®¡
    apha=-2*cos(2*pi*f0*Ts);
    beta=0.96;
    b=[1 apha 1];
    a=[1 apha*beta beta^2];
```

***

#### 4.å…³äºå¸¦é€šæ»¤æ³¢çš„é—®é¢˜

ä»£ç é‡Œå†™çš„æ˜¯`4~90Hz`,ä½†æ˜¯è¿™ä¸ªèŒƒå›´å¤ªå®½äº†ï¼Œè·Ÿæ²¡æœ‰æ»¤æ³¢ä¸€æ ·ï¼Œé¢„è®¡åæœŸæ”¹æˆ`70Hz`ï¼Œå†çœ‹å‡ºå›¾æ•ˆæœ

```matlab
%% 4-90Hzå¸¦é€šæ»¤æ³¢
%è¿™åœ°æ–¹è®ºæ–‡é‡Œå¦‚ä½•ç¡®å®šé˜¶æ•°å‘¢ï¼Ÿä½†æ˜¯è®ºæ–‡é‡Œä¼¼ä¹ä¸éœ€è¦å¯¹æ¯ä¸ªå‚æ•°çš„è·å¾—è¿›è¡Œè¯´æ˜ï¼Œä¸»è¦è¿˜æ˜¯å°šè€å¸ˆé‚£è¾¹ï¼Œå•§å•§å•§
%ä½¿ç”¨matlabè‡ªå¸¦çš„buttordå‡½æ•°å¯ä»¥è¿”å›é˜¶æ•°Nï¼Œè¿”å›çš„å‚æ•°ä¸€ä¸ªæ˜¯é˜¶æ•°Nï¼Œå¦ä¸€ä¸ªæ˜¯æˆªæ­¢é¢‘ç‡

[b, a] = butter_bandpass(5, 90, fs, 3);  %è¿™é‡Œå°è£…äº†ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨æ–‡ä»¶å¤¹ä¸‹ä¹Ÿç»™å‡ºäº†ï¼Œå‚æ•°ä¸º(f1,f2,é‡‡æ ·ç‡,é˜¶æ•°)
sig_after_Filt = filtfilt(b, a, sig_after_notch);
```

é‡è¦çš„ç‚¹æ˜¯å…³äºæ»¤æ³¢å™¨é˜¶æ•°çš„é€‰æ‹©ï¼šN

é¦–å…ˆç»™å‡ºå®šä¹‰ï¼šæ»¤æ³¢å™¨åˆé€‚çš„é˜¶æ•°å°±æ˜¯åœ¨æ»¡è¶³æ€§èƒ½æŒ‡æ ‡è¦æ±‚çš„å‰æä¸‹çš„æœ€å°é˜¶æ•°ï¼Œæ¢å¥è¯è¯´ï¼Œéœ€è¦åšçš„å°±æ˜¯æ ¹æ®ç»™å®šçš„æŒ‡æ ‡é€‰æ‹©æœ€å°é˜¶æ•°ã€‚

è°ƒç”¨çš„æ˜¯`Buttword`å‡½æ•°æ¥è¿›è¡Œæ»¤æ³¢å™¨é˜¶æ•°çš„é€‰æ‹©

ä½¿ç”¨çš„æ˜¯`butter_bandpass`å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„ä¸€ä¸ªå‡½æ•°ï¼Œä½†æ˜¯ä¹Ÿæ˜¯è°ƒç”¨äº†`matlab`é‡Œé¢çš„`butter`è¿›è¡Œæœ€åçš„å¤„ç†

```matlab
function [b,a] = butter_bandpass(lowcut, highcut, fs, order)
    %æ»¤æ³¢å™¨åˆé€‚çš„é˜¶æ•°å°±æ˜¯è¯´åœ¨æ»¡è¶³æ€§èƒ½æŒ‡æ ‡è¦æ±‚çš„å‰æä¸‹çš„æœ€å°é˜¶æ•°
    nyq = 0.5*fs;%ä¹˜ä»¥0.5æ˜¯è¦è¿›è¡Œå½’ä¸€åŒ–ï¼Œå«åšåˆ†æé¢‘ç‡
    low = lowcut / nyq;
    high = highcut /nyq;
    [b,a] = butter(order, [low, high]);
```

`butter_bandpass`å‡½æ•°ä¸­å¯¹`nyp=fs/2`è¿›è¡Œå¤„ç†ï¼Œè¿™å«åšåˆ†æé¢‘ç‡ï¼Œç”¨å¸¦é€šçš„ä¸¤ä¸ªè¾¹ç¼˜çš„é¢‘ç‡å»é™¤ä»¥åˆ†æé¢‘ç‡å°±æ˜¯å½’ä¸€åŒ–æˆªæ­¢é¢‘ç‡` low`ä¸`high`

***

#### 5.ä¿¡å·å¤„ç†ä¸­çš„å‚æ•°è®¾å®šé—®é¢˜ï¼š

å…·ä½“å¯ä»¥çœ‹ä¸‹åšå®¢[matlab butter()å‡½æ•°è§£æ_ACE-Mayerçš„åšå®¢-CSDNåšå®¢_matlab butterå‡½æ•°](https://blog.csdn.net/sunmingyang1987/article/details/103597617)

```matlab
fs=250;%é‡‡æ ·é¢‘ç‡ï¼Œå¯ä»openbciè½¯ä»¶ä¸Šè®¾å®š
Ts=1/fs;%æ—¶é—´é—´éš”ä¸ºé‡‡æ ·é¢‘ç‡çš„å€’æ•°
fmaxd=3;%æˆªæ­¢é¢‘ç‡ä¸º3Hz
fmaxn=fmaxd/(fs/2);
%butterå‡½æ•°æ˜¯æ±‚å·´ç‰¹æ²ƒæ–¯æ•°å­—æ»¤æ³¢å™¨çš„ç³»æ•°
%ä¸‹é¢çš„fmaxnæ˜¯è¿™ä¸ªå‡½æ•°çš„ç‰¹æœ‰å‚æ•°ï¼Œå«å½’ä¸€åŒ–æˆªæ­¢é¢‘ç‡ï¼Œåˆå«è‡ªç„¶é¢‘ç‡ï¼Œfmaxn=æˆªæ­¢é¢‘ç‡*2/é‡‡æ ·é¢‘ç‡
%æ‰€ä»¥atlå†™çš„éå¸¸å¯¹ï¼Œåªæ˜¯æ²¡å†™æ³¨é‡Š
%å¦‚æœfmaxnä½ç½®åªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆæ˜¯è¦ç•™ä¸‹å°äºæˆªè‡³é¢‘ç‡çš„ä¿¡å·ï¼Œä¹Ÿå°±æ˜¯ä½é€šæ»¤æ³¢
```

***

##### 6.å…³äºFFTè½¬æ¢åˆ°é¢‘åŸŸè¿™ä¸€æ“ä½œ

å†™è®ºæ–‡æ—¶å€™è¦ä»‹ç»`DFT`å’Œ`FFT`ï¼Œä¸Šç½‘å»æŸ¥èµ„æ–™å¯å‚è€ƒ[Matlabä¸­fftå‡½æ•°çš„ä½¿ç”¨ä¸åŸç†_DylanXiçš„åšå®¢-CSDNåšå®¢_matlab fft](https://blog.csdn.net/defu123sss/article/details/80457699?ops_request_misc={"request_id"%3A"164903268316781685367589"%2C"scm"%3A"20140713.130102334.pc_all."}&request_id=164903268316781685367589&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-4-80457699.142^v5^pc_search_result_cache,157^v4^control&utm_term=fftå‡½æ•°matlab&spm=1018.2226.3001.4187),ä»‹ç»ä¸ºä»€ä¹ˆæ˜¯ç”¨FFTçš„åŸå› ï¼Œ**<u>åˆ—å‡ºå…¬å¼</u>**

å…³äºä»£ç ï¼Œä»¥å»åŸºçº¿æ¼‚ç§»åçš„æ•°æ®ä¸ºä¾‹ï¼š

```matlab
%% ç”»å»åŸºçº¿æ¼‚ç§»å¤„ç†åçš„é¢‘è°±å›¾
% fft
N=2^nextpow2(length(sig_raw));  %å»æ‰¾2çš„å€æ•°çš„ç‚¹å»åšFFT
%nextpow2å¯»æ‰¾çš„æ˜¯æœ€æ¥è¿‘åé¢å‚æ•°çš„2çš„å¹‚æ¬¡ã€‚åœ¨è¿™é‡Œlength(sig_raw)=710ï¼Œé‚£ä¹ˆnextpow2(length(sig_raw))çš„å€¼ä¸º10
T=1/Fs;
f1=(0:(N-1))/(N*T);  

%å»é™¤åŸºçº¿æ¼‚ç§»ä¹‹åçš„é¢‘è°±
amplitude = abs(fft(sig_after_detrend,N));  
amplitude = amplitude*2/N;
amplitude(1) = amplitude(1)/2;
data2 = amplitude;
subplot(4,2,4),plot(f1, data2,'linewidth', 1), xlim([5 80]), %ylim([0 3])
xlabel('Frequency(Hz)'), ylabel('Amplitude'),title('å»é™¤åŸºçº¿æ¼‚ç§»ä¹‹åçš„é¢‘è°±å›¾');
```

å…¶ä¸­ï¼Œ`f1`è¿™ä¹ˆå†™çš„åŸå› å¦‚ä¸‹ï¼š

![image-20230112203851571](https://cdn.jsdelivr.net/gh/Bu0717/image/imgimage-20230112203851571.png)

`FFT`æ‰€èƒ½åˆ†è¾¨çš„æœ€å°é¢‘ç‡ä¸º`Fn`ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©`Fn`ä½œä¸ºæ¨ªåæ ‡çš„é—´éš”ï¼Œåœ¨ä»£ç é‡Œå°±æ˜¯`f1`ï¼Œæ˜¯ä¸€ä¸ª `FFT`ç‚¹æ•°ä¹˜ä»¥*1(æˆ–1*ä¹˜ä»¥`FFT`)çš„å‘é‡



`amplitude`(å‚…é‡Œå¶å˜æ¢åçš„å¹…åº¦)è¿™ä¹ˆå†™çš„åŸå› ï¼š

![image-20230112203955649](https://cdn.jsdelivr.net/gh/Bu0717/image/imgimage-20230112203955649.png)

æ‰€ä»¥å¯ä»¥çœ‹ä½œæ˜¯è¿™ä¸ªæ„æ€ï¼š

è¿›è¡Œäº†`FFT`ä»¥åè¾“å‡ºçš„`y`ï¼ˆé™¤äº†ç›´æµåˆ†é‡ç‚¹ï¼‰ï¼Œæˆ‘ä»¬å¯¹å…¶é™¤ä»¥`N`ä¹˜ä»¥2æ‰æ˜¯çœŸå®å¹…å€¼ï¼Œä¸”`N`è¶Šå¤§ï¼Œå¹…å€¼ç²¾åº¦è¶Šé«˜ï¼Œä½†æ˜¯`N`è¶Šå¤§çš„ä»£ä»·æ˜¯è®¡ç®—é‡çš„åŠ å¤§ï¼Œå› æ­¤åœ¨ä¸€èˆ¬çš„`FFT`é¢‘è°±å˜æ¢ä¸­ï¼Œæˆ‘ä»¬åªå¯¹Nå–åˆ°ï¼š`N=2^n`>æ•°æ®æ€»é‡(è¿™é‡Œæ˜¯710)ï¼Œä¹Ÿå°±æ˜¯è¯´`N`å–1024å³å¯ï¼Œè¶³ä»¥æ»¡è¶³æˆ‘ä»¬è®¡ç®—ç²¾åº¦çš„è¦æ±‚

å¯¹äºç›´æµåˆ†é‡ç‚¹ï¼Œæˆ‘ä»¬åªéœ€è¦å¯¹å…¶ç›´æ¥é™¤ä»¥2å°±å¯ä»¥äº†ï¼Œæ‰€ä»¥åœ¨ä¸Šé¢ä»£ç é‡Œï¼Œæˆ‘ä»¬å°†`amplitude(1)`å–å‡ºï¼Œå°†å®ƒé™¤ä»¥2

æ‰€ä»¥æˆ‘ä»¬ä¸‹é¢ç”»å›¾çš„è¯ï¼Œ`x`åæ ‡å°±æ˜¯`f1`ï¼Œ`y`åæ ‡å°±æ˜¯è¾“å‡ºçš„`amplitude`

***

### å…³äºåœ¨çº¿BCIä»¥åŠonline_analysisçš„è¯´æ˜

`LSL`çš„åº“ï¼Œéœ€è¦å°†è¯¥æ–‡ä»¶åŠå…¶æ–‡ä»¶å¤¹å®Œæ•´çš„æ·»åŠ åˆ°`Matlab`è·¯å¾„ï¼Œå…·ä½“å¯è§[LSLçš„Github](https://github.com/sccn/labstreaminglayer)

```matlab
%% LSL æ¥å—ä»OpenBCIä¼ å›æ¥çš„æ•°æ®
disp('Loading the library...');
lib = lsl_loadlib();
% resolve a stream...
disp('Resolving an EEG stream...');
result = {};
while isempty(result)
    result = lsl_resolve_byprop(lib,'type','EEG'); 
end
% create a new inlet
disp('Opening an inlet...');
inlet = lsl_inlet(result{1});
[vec,ts] = inlet.pull_sample();%1.è¿™é‡Œé¦–å…ˆè·å¾—ä¸€ä¸ªæ—¶åˆ»
disp('æˆåŠŸæ¥æ”¶åˆ°æ•°æ®...');
fprintf('%.2f\t\t',vec);
fprintf('\n');
%ä»è¿™é‡Œå¾€ä¸Šçš„ä»£ç éƒ½æ˜¯lslæ•°æ®æµé‡Œé¢çš„ä»£ç ï¼Œéƒ½æ˜¯å°è£…å¥½äº†çš„ï¼Œå°±è¿™ä¹ˆå†™å°±å¯ä»¥äº†
%è‡³äºä¸ºå•¥ç­‰é‚£ä¸ªæ”¾å¤§å™¨æ¥äº†ä¹‹åçœ‹çœ‹
```

æœ‰å…³è¿™ä¸€å—çš„ä»£ç ï¼Œéƒ½æ˜¯`Open-BCI`é‡Œé¢é’ˆå¯¹`LSL`æ•°æ®æµçš„ç‰¹å®šå†™æ³•å¯å‚è€ƒ[2020-03-31-LSLHands On_é™ˆé”CRçš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/craig_cc/article/details/105561226?ops_request_misc={"request_id"%3A"164903411016780271560363"%2C"scm"%3A"20140713.130102334.."}&request_id=164903411016780271560363&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~sobaiduend~default-1-105561226.article_score_rank_blog&utm_term=inlet.pull_sample&spm=1018.2226.3001.4450)

é‡è¦æ˜¯é‚£è¡Œ`[vec,ts] = inlet.pull_sample()`ï¼Œä¸‹é¢ä¼šæœ‰è¯¦ç»†è¯´æ˜ã€‚

å…³äºå¾ªç¯é‡Œé¢çš„ä»£ç ï¼š

```matlab
for i=1:4    %trialæ¬¡æ•°ã€ä¹Ÿå°±æ˜¯å®éªŒæ¬¡æ•°
    while ts - start < 4    %ä¿®æ”¹æ¯ä¸€ä¸ªtrialé‡‡é›†ä¿¡å·çš„æ—¶é•¿,å¦‚æœå½“å‰é‡‡å›æ¥çš„é‚£ä¸ªæ—¶é—´ä¸å¤§äºstartå°±ä¸€ç›´é‡‡ï¼Œæ‰€ä»¥æ‰ä¼šæœ‰4sï¼Œ1000æ•°æ®
        [vec,ts] = inlet.pull_sample();%3.è¿™é‡Œå†æ¬¡è·å¾—ä¸€ä¸ªæ—¶åˆ»ï¼Œå¹¶ä¸”æ­¤æ—¶è¿™ä¸ªæ—¶åˆ»è‚¯å®šå·²ç»å¤§äºå¼€å§‹çš„æ—¶åˆ»äº†
        eeg_record = [eeg_record; vec];  %ä¸€æ•°åˆ—æ˜¯ä¸€ä¸ªé€šé“
        %è¿™æ˜¯å¾€eeg_recordè¿™ä¸ªçŸ©é˜µæœ¬èº«é‡Œæ·»åŠ æ•°æ®ï¼Œä¸€è¡Œä¸€è¡Œçš„æ·»åŠ ï¼Œæœ€åå¦‚æœå‡†ç¡®çš„è¯åº”è¯¥æ˜¯ä¸€ä¸ª ï¼š1000*8çš„çŸ©é˜µ
    end
    %è¿™é‡Œéœ€è¦å¯¹è¿™ä¸€æ¬¡å¾ªç¯ï¼Œtrialä¹Ÿå°±æ˜¯ä¸€æ¬¡å®éªŒè¿‡ç¨‹é‡Œé¢è¿›è¡Œè§£é‡Š
    %è·å–æ•°æ®æ˜¯é€šè¿‡[vec,ts] = inlet.pull_sample()è¿™ä¸€è¡Œå‘½ä»¤æ¥è·å¾—çš„ï¼Œå¹¶ä¸”è¿˜å¯ä»¥è·å¾—æ­¤æ—¶çš„æ—¶åˆ»ts
    %æ‰€ä»¥å¦‚æœè·å–äº†æ—¶åˆ»å°±å¯ä»¥å¯¹æ—¶é—´è¿›è¡Œæ›´æ–°ï¼Œè¿™æ˜¯æˆ‘ä»¬è¿›è¡Œåˆºæ¿€æ—¶é—´æ§åˆ¶çš„é‡è¦è¯­å¥
    %å¦ä¸€ä¸ªé‡è¦çš„å‚æ•°æ˜¯vecï¼Œè¿™æ˜¯è·å–çš„æ­¤åˆ»é‡‡å›æ¥çš„å…«é€šé“æ•°æ®ï¼Œæœ¬è´¨ä¸Švecåœ¨é‡‡æ ·çš„é‚£ä¸€æ—¶åˆ»è·å–çš„åº”è¯¥æ˜¯1*8çš„æ•°æ®
    %å¹¶ä¸”æ¯ä¸ªå°çš„æ—¶é—´æ®µæ˜¯ï¼š1/250ç§’ï¼Œå°±æ˜¯è·Ÿé‡‡æ ·é€Ÿç‡æœ‰å…³çš„ä¸€ä¸ªæ•°å€¼
    %æ‰€ä»¥åœ¨250hzçš„é‡‡æ ·é¢‘ç‡ä¸‹ï¼Œä¸€ç§’é’Ÿé‡‡æ ·250æ¬¡ï¼Œä¹Ÿå°±æ˜¯250ä¸ªvecï¼Œé‚£ä¹ˆæŒ‰ç…§ç†è®ºæ¥è®²å››ç§’ç§å°±ä¼šè·å¾—1000*8çš„ä¸€ä¸ªæ•°æ®ç»„
    %æ‰€ä»¥æŒ‰ç…§ç†è®ºæ¥è¯´ï¼Œeeg_recordé‡Œé¢åœ¨ä¸€æ¬¡içš„éå†ä¸‹æ˜¯ä¸€ä¸ª1000*8çš„çŸ©é˜µï¼Œå¯æƒœæˆ‘ä»¬çš„ä»ªå™¨è¾¾ä¸åˆ°è¿™æ ·çš„æ°´å‡†ï¼Œæ¯ç§’é’Ÿé‡‡ä¸åˆ°250ä¸ªæ•°æ®ç‚¹ï¼Œæ‰€ä»¥åœ¨ä¸‹é¢å°±å–äº†å‰900çš„
    %
    
   %% å°†åœ¨çº¿åˆ†æé‡‡é›†çš„æ•°æ®å­˜ä¸ºcsvæ–‡ä»¶ï¼Œä»¥ä¾›ç¦»çº¿åˆ†æï¼Œåœ¨å®é™…åœ¨çº¿åˆ†æçš„æ—¶å€™ä¸éœ€è¦å­˜å‚¨æ•°æ®
    % data_table = array2table(eeg_record);   
    % filename=['D:\ATL\BCI_design\Finally_code\online_BCI\data2\7.5Hz_1_', num2str(i), '.csv'];
    % writetable(data_table,filename);
    
    %% å°†ä¸€æ¬¡å®éªŒ(iå¾ªç¯ä¸€æ¬¡å°±æ˜¯ä¸€æ¬¡å®éªŒ)æ•°æ®è¿›è¡Œä¸€ä¸ªè½¬æ¢
    eeg_oz = eeg_record(:,3); % ä»…ä½¿ç”¨8ä¸ªé€šé“é‡Œé¢POzé€šé“çš„æ•°æ® (åˆ—æ•°æ®)ï¼ŒPOzåº”è¯¥æ˜¯æ•å¶åŒº
    %å› ä¸ºåœ¨ç¦»çº¿åˆ†æã€å¯¹æ¸…åçš„Rawæ•°æ®ï¼Œæˆ‘ä»¬æ‰€è¿›è¡Œçš„å°±æ˜¯ä¸€ä¸ªé€šé“çš„åˆ†æ
    eeg_record = [];%æ¸…ç©ºæ­¤æ¬¡iå¾ªç¯çš„æ•°æ®
    EEG_DATA(:,i) = eeg_oz(1:900,1);  % è¿™é‡Œå–Ozçš„1-900ä¸ªæ•°æ®ç‚¹æ˜¯å› ä¸ºï¼ŒOpenBCIçš„é‡‡æ ·ç‡ä¸ç¨³å®šï¼Œé€‰250Hzï¼Œå¯èƒ½å®é™…åªé‡‡é›†247ä¸ª
    [vec,ts] = inlet.pull_sample();%é‡æ–°æ›´æ–°è¿™ä¸ªæ—¶é—´
    start = ts;%å†æŠŠè¿™ä¸ªæ—¶é—´ç‚¹å½“ä½œæ–°ä¸€è½®çš„å¼€å§‹æ—¶é—´ï¼Œå»è¿›è¡Œæ–°ä¸€è½®çš„4ç§’
end
```

***

### å…³äºsig_pro_allçš„ä»£ç 

ä¸Šé¢çš„`online_analysis`ä»£ç æœ€åå¾—åˆ°çš„`EEG_DATA`æ˜¯ä¸€ä¸ª `point x trail = 900*4 `çš„çŸ©é˜µï¼Œ900æŒ‡çš„æ˜¯æ•°æ®ç‚¹æ•°ï¼Œ4æŒ‡çš„æ˜¯4æ¬¡å®éªŒæ¬¡æ•°ï¼Œç„¶åæŠŠè¿™ä¸ªæ•°æ®æ‰”è¿›`sig_pro_al`lä¸­å»å¤„ç†

```matlab
%% å°†é‡‡é›†çš„RAWæ•°æ®é¢„å¤„ç†,å¹¶è¿”å›é¢‘è°±å¹…å€¼æœ€å¤§å€¼æ‰€å¯¹åº”çš„é¢‘ç‡å€¼ï¼Œâ€œå½“åšâ€æœ€åçš„è¯†åˆ«ç»“æœ
%æš‚æ—¶åªå–ä¸€ä¸ªé€šé“çš„æ•°æ®ï¼Œ
%EEG_DATA,ç°åœ¨æ˜¯ point*trail  900*4 çš„ï¼Œç„¶åæŠŠè¿™ä¸ªæ•°æ®æ‰”è¿›å»å¤„ç†
result = sig_pro_all(EEG_DATA);  %æ¯ä¸€åˆ—ï¼Œæ˜¯ä¸€ä¸ªé€šé“çš„æ•°æ®
fprintf('ç¨‹åºè¯†åˆ«åçš„åˆºæ¿€é¢‘ç‡ä¸ºï¼š%.2f\n',result);
```

`sig_pro_all`å‡½æ•°é‡Œé¢çš„ä»£ç ï¼š

```matlab
%% å‡½æ•°è¯´æ˜ sig_pro_all,å³ signal_processing_all
% è¯¥å‡½æ•°æ˜¯ç”¨æ¥å°†ä¼ å…¥çš„RAWè„‘ç”µä¿¡å·è¿›è¡Œé¢„å¤„ç†å¹¶é€šè¿‡é¢‘è°±å¹…å€¼åˆ¤æ–­äº§ç”Ÿå½“å‰è„‘ç”µä¿¡å·çš„åˆºæ¿€é¢‘ç‡
% æœ€ç»ˆå°†é¢‘ç‡åˆ¤æ–­çš„ç»“æœè¿”å›ç»™ä¸»ç¨‹åºä¸­
% è¿™é‡Œä»…ç”¨é¢‘è°±çš„æœ€é«˜å¹…å€¼åˆ¤æ–­æœ‰é—®é¢˜ï¼Œè¾ƒå¥½çš„æ–¹æ³•åº”å‚ç…§ä»¥ä¸‹æ–‡çŒ®ï¼š
%
% @ARTICLE{1035968,
%   author={Ming Cheng and Xiaorong Gao and Shangkai Gao and Dingfeng Xu},
%   journal={IEEE Transactions on Biomedical Engineering}, 
%   title={Design and implementation of a brain-computer interface with high transfer rates}, 
%   year={2002},
%   volume={49},
%   number={10},
%   pages={1181-1186},
%   doi={10.1109/TBME.2002.803536}}

%% å‚æ•°è¯´æ˜
% DATAæ˜¯raw EEGæ•°æ®,æ ¹æ®æ–‡çŒ®ä¸­çš„æ€æƒ³ï¼Œæ˜¯å­˜æ”¾æœ‰æŸä¸€é€šé“çš„Næ¬¡è¯•éªŒ/Nä¸ªäººçš„ï¼ŒåŒä¸€é—ªçƒåˆºæ¿€ä¸‹çš„è„‘ç”µrawæ•°æ®
% DATAæ˜¯ä¸€ä¸ªpoint*trialå½¢çŠ¶çš„æ•°æ®çŸ©é˜µ
% pointï¼šé‡‡æ ·ç‡*é‡‡æ ·æ—¶é—´ï¼Œå³è„‘ç”µæ•°æ®çš„ç‚¹æ•°
% trialï¼šNæ¬¡è¯•éªŒï¼ˆNä¸ªäººï¼‰çš„è„‘ç”µæ•°æ®
% å¯è§ï¼ŒDATAæ˜¯æŒ‰åˆ—æ’åˆ—çš„ä¸€ä¸ªæ•°æ®çŸ©é˜µï¼Œæ¯ä¸€åˆ—çš„æ‰€æœ‰è¡Œä»£è¡¨ä¸€ä¸ªé€šé“çš„ä¸€æ¬¡å®éªŒçš„æ‰€æœ‰æ•°æ®ç‚¹
% åœ¨æœ¬ç¨‹åºä¸­çš„ä¿¡å·å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š
% RAWæ•°æ®-->å»é™¤åŸºçº¿æ¼‚ç§»-->50Hzé™·æ³¢æ»¤æ³¢-->3-20Hzå¸¦é€šæ»¤æ³¢-->å¯¹å¤„ç†å¥½çš„Næ¬¡trialæ•°æ®å–å¹³å‡-->FFTå¹¶è¿”å›é¢‘è°±å¹…å€¼æœ€å¤§å€¼å¯¹åº”çš„é¢‘ç‡å€¼

%% ç¨‹åº
function [result] = sig_pro_all(DATA)
    %ä¼ å…¥æ•°æ®
    [point,trial] = size(DATA); 

    result_sig = [];
    for i=1:trial%trialçš„å€¼ä¸º4ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ä¸»å‡½æ•°é‡Œé¢å®šä¹‰çš„å®éªŒè½®æ¬¡
        sig_raw = DATA(:,i);
        
       %% å»é™¤åŸºçº¿æ¼‚ç§»  è¿™é‡Œéœ€è¦ç»™åˆ—æ•°æ®
        NLen=length(sig_raw);
        fs=250;           %é‡‡æ ·é¢‘ç‡ï¼Œå¯ä»è½¯ä»¶ä¸Šè®¾å®š
        Ts=1/fs;          %æ—¶é—´é—´éš”ä¸ºé‡‡æ ·é¢‘ç‡çš„å€’æ•°
        fmaxd=5;          %æˆªæ­¢é¢‘ç‡ä¸º5Hz
        fmaxn=fmaxd/(fs/2);
        [b,a]=butter(1,fmaxn,'low');
        data_3Hz = filtfilt(b,a,sig_raw);       %é€šè¿‡5Hzä½é€šæ»¤æ³¢å™¨çš„ä¿¡å·
        sig_after_detrend = sig_raw - data_3Hz; %å»é™¤è¿™ä¸€æ®µä¿¡å·ï¼Œå¾—åˆ°å»åŸºçº¿æ¼‚ç§»çš„ä¿¡å·

       %% 50Hz é™·æ³¢æ»¤æ³¢
        % æ³¨æ„ï¼Œç”±äºbrainflowåº“çš„é™åˆ¶ï¼Œè¿™é‡Œéœ€è¦ç»™çš„æ•°æ®ä¸ºè¡Œæ•°æ®ï¼Œå³æ¯ä¸€é€šé“çš„è„‘ç”µæ•°æ®è¦ç”¨ä¸€è¡Œæ¥è¾“å…¥ï¼Œæ‰€ä»¥è¿™é‡Œæœ‰ä¸ªè½¬ç½®
        sig_after_notch = DataFilter.perform_bandstop(sig_after_detrend', 250, 50, 2, 5, 0, 0.2);  %50Hzå·¥é¢‘çš„å¸¦é˜»
        sig_after_notch = sig_after_notch';

        

        %% 3-20å¸¦é€šæ»¤æ³¢ï¼Œå› ä¸ºåœ¨å†™çš„æ—¶å€™æ˜¯æƒ³æ¥æ§åˆ¶å°è½¦çš„è¿åŠ¨ï¼Œå‰8 å10 å·¦12 å³14 æ‰€ä»¥åªéœ€è¦å››ä¸ªé¢‘ç‡ä¿¡å·ï¼Œå¸¦é€šæ»¤æ³¢ä¹Ÿåªè¦3~20Hz
        Fs=250; %é‡‡æ ·ç‡
        [b, a] = butter_bandpass(3,20,Fs, 2);
        sig_after_Filt = filtfilt(b, a, sig_after_notch);

        %% é¢„å¤„ç†å®Œçš„æ•°æ®
        result_sig = [result_sig, sig_after_Filt]; %å°†é¢„å¤„ç†å®Œçš„æ•°æ®å­˜å…¥æ–°çš„ä¸€ä¸ªçŸ©é˜µä¸­--->result_sig
    end
    
    %æ¯ä¸€æ¬¡trialè¦å®Œæˆæ•´ä¸ªçš„æ•°æ®é¢„å¤„ç†è¿‡ç¨‹ï¼Œå››æ¬¡åˆ†å¼€å¤„ç†ï¼Œå®Œäº†ä»¥åå†ç”¨ä¸‹é¢ä¸€è¡Œä»£ç å»å¯¹å¤„ç†å¥½çš„4æ¬¡åšå¹³å‡ï¼Œå†ç”¨4æ¬¡é¢„å¤„ç†å®Œã€å¹³å‡å®Œçš„æ•°æ®åšFFT
    %% å¯¹é¢„å¤„ç†å®Œçš„è„‘ç”µæ•°æ®åšå¹³å‡
    result_sig_mean = mean(result_sig,2);  
    
    %% fft
    N=2^nextpow2(length(sig_raw));
    T=1/Fs;
    f1=(0:(N-1))/(N*T);   
    amplitude = abs(fft(result_sig_mean,N));
    amplitude = amplitude*2/N;
    amplitude(1) = amplitude(1)/2;
    data2 = amplitude;

    %% è¿”å›é¢‘è°±ä¸­å¹…å€¼æœ€é«˜çš„æ‰€å¯¹åº”çš„é¢‘ç‡å€¼
    [~,result] = max(data2);%è¿™é‡Œç›´æ¥å¯»æ‰¾çš„æ˜¯æœ€å¤§å€¼ï¼Œå°±åƒå‰é¢è¯´çš„ï¼Œè¿™ç§æ–¹æ³•æ˜¯æœ‰å±€é™çš„
    result = f1(result);
```

è¿™é‡Œæœ€é‡è¦çš„å°±æ˜¯é€šè¿‡çœ‹è®ºæ–‡ä»¥åï¼Œå¦‚ä½•å»å¯»æ‰¾ä¸€ç§å¹¶ä¸æ˜¯æ¯æ¬¡éƒ½æ‰¾æœ€å¤§å€¼æ¥ä½œä¸ºé¢‘ç‡çš„æ–¹æ³•ï¼Ÿ

è¿™ä¸ªå‡½æ•°è¿˜æ˜¯éå¸¸çš„é‡è¦çš„ï¼ŒåŒ…å«äº†å‰é¢`offline_analysis`é‡Œé¢çš„ä¸€äº›å†…å®¹ï¼Œæ‰€ä»¥è¿˜æ˜¯è¦å¥½å¥½çœ‹çœ‹

è®ºæ–‡é“¾æ¥å¦‚ä¸‹ğŸ‘‡ğŸ‘‡ğŸ‘‡

[Design and implementation of a brain-computer interface with high transfer rates | IEEE Journals & Magazine | IEEE Xplore](https://ieeexplore.ieee.org/document/1035968)

***

### å…³äºdataAnalysisä»£ç è¯´æ˜

```matlab
% Data analysis for the benchmark dataset
% æ•°æ®åˆ†æç”¨çš„æ˜¯benchmarkæ•°æ®é›†ï¼Œå°±æ˜¯æ¸…åå¤§å­¦å·²ç»é¢„å¤„ç†å®Œçš„æ•°æ®é›†

% Time domain:Trial average -> Bandpass filt -> subject average
% æ—¶åŸŸåˆ†æï¼šå¸¦é€šæ»¤æ³¢->å®éªŒæ¬¡æ•°å¹³å‡->å®éªŒè€…å¹³å‡       è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºä¸éœ€è¦é¢„å¤„ç†è¿‡ç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œçš„æ—¶åŸŸåˆ†æä¸é¢‘åŸŸåˆ†æéƒ½æ˜¾å¾—ç®€å•

% Frequency domain: Trial average -> FFT -> subject average -> Data tuncation 
%é¢‘åŸŸåˆ†æ: å®éªŒæ¬¡æ•°å¹³å‡ ->FFT ->å®éªŒè€…å¹³å‡->æ•°æ®æˆªæ–­(å°±æ˜¯åœ¨ç”»å›¾çš„æ—¶å€™åªç”»å‡ºäº†5~80é¢‘ç‡ä¹‹é—´çš„å›¾)
%åœ¨è¿™ä¸ªä»£ç é‡Œé¢é¢‘åŸŸä¿¡å·å¹¶æ²¡æœ‰ç»è¿‡å¸¦é€šæ»¤æ³¢ï¼Œæ€ä¹ˆçœ‹æœ‰æ²¡æœ‰ç»è¿‡å‘¢ï¼Ÿä»ä»£ç ä¸Šå¯ä»¥çœ‹åˆ°åšFFTæ—¶å€™ç”¨çš„æ˜¯dataï¼Œè€Œä¸æ˜¯é€šè¿‡å¸¦é€šæ»¤æ³¢å™¨çš„data1
%ä»æœ€åç”»çš„å›¾åƒé‡Œé¢å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ˜¯ç»è¿‡å¸¦é€šçš„ï¼Œé‚£ä¹ˆå‰é¢ä¸€æ®µåº”è¯¥å¹…å€¼æ¥è¿‘äº0ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰
clear all
close all
clc

Fs = 250;                           %%é‡‡æ ·ç‡250Hz ä¹ˆçš„é—®é¢˜(get)
Wp = [7/Fs*2, 70/Fs*2];
Ws = [4/Fs*2, 75/Fs*2];%æ•°å€¼çš„é€‰æ‹©æ˜¯æ»¤æ³¢å™¨çš„è¿‡æ¸¡ï¼Œä¸‹é¢ç”»äº†ä¸ªå›¾ï¼Œåœ¨å›¾é‡Œå¾ˆæ¸…æ™°
[N, Wn]=cheb1ord(Wp, Ws, 0.5, 40);
[b, a] = cheby1(N, 0.5, Wn);
[h, w] = freqz(b,a);
f=(0:length(w)-1)*Fs/2/length(w);
%çœ‹ä¸€ä¸‹matlabå®˜ç½‘å…³äºè¿™ä¸ªæ»¤æ³¢å™¨çš„è¯´æ˜
%å®è´¨ä¸Šå°±æ˜¯ä¸€ç§æ»¤æ³¢å™¨çš„è®¾è®¡ï¼Œå¹¶ä¸”åœ¨æ­¤ä¾‹ä¸­æˆ‘ä»¬è®¾è®¡çš„æ˜¯åˆ‡æ¯”é›ªå¤«Iå‹å¸¦é€šæ»¤æ³¢å™¨
figure
plot(f,abs(h)), grid;
xlabel('Frequency (Hz)')
ylabel('Magnitude')
```

ç„¶åå°±æ˜¯è¦è¿›è¡Œæ—¶åŸŸçš„ä¸é¢‘åŸŸçš„å›¾åƒç»˜åˆ¶ï¼Œè¿™ç›´æ¥çœ‹ä»£ç å°±è¡Œ

ä½†è¿™é‡Œç‰µæ‰¯åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åˆ°åº•æ˜¯å…ˆå¯¹åŸå§‹æ•°æ®å–å¹³å‡è¿˜æ˜¯å…ˆå¯¹åŸå§‹æ•°æ®æ»¤æ³¢ã€ä½œFFTä»¥åå†å–å¹³å‡ï¼Ÿ

è¿™ä¸ªé—®é¢˜å¹¶æ²¡æœ‰æ„ä¹‰ï¼Œè¿™æ˜¯å‚…é‡Œå¶å˜æ¢çš„ç¬¬ä¸€æ¡æ€§è´¨ä¹Ÿå°±æ˜¯çº¿æ€§æ€§è´¨ï¼Œæ‰€ä»¥å…ˆåšFFTå†å¹³å‡æˆ–è€…æ˜¯å…ˆå¯¹æ—¶åŸŸä¿¡å·å¹³å‡å†åšFFTï¼Œä»ç†è®ºä¸Šè®²äºŒè€…æ˜¯ä¸€æ ·çš„

è®ºæ–‡é‡Œé¢**<u>åˆ—å‡ºè¿™ä¸ªå…¬å¼</u>**

é‡åº†å¤§å­¦é‚£ä¸ªå°å“¥çš„åŸå§‹ä»£ç ä¸­ç‰¹åˆ«å¼ºè°ƒäº†ï¼Œæ—¶åŸŸçš„åˆ†æä¸­ä¸åŒå®éªŒè€…çš„å¹³å‡å’Œå¸¦é€šæ»¤æ³¢æ˜¯å¯ä»¥äº’æ¢çš„

ä½†åœ¨é¢‘åŸŸä¸­ï¼ŒåšFFTä¸ä¸åŒå®éªŒè€…çš„å¹³å‡ä¸å¯ä»¥è¿›è¡Œäº’æ¢ï¼Œè¿™åœ°æ–¹æˆ‘æ˜¯çœŸä¸çŸ¥é“ä¸ºå•¥äº†

ä»£ç é‡Œå¯è¡Œçš„åŠæ³•æ˜¯ï¼šå…ˆå¯¹ä¸€ä¸ªäººçš„å¤šæ¬¡å®éªŒä¿¡å·å–å¹³å‡ååšFFTï¼Œå†å¯¹ä¸åŒçš„å®éªŒè€…çš„FFTå–å¹³å‡



å…³äºSNRä¿¡å™ªæ¯”ï¼šè®ºæ–‡ä¸­æåˆ°ï¼Œä¿¡å™ªè¢«å¹¿æ³›çš„ç”¨äºè¯„ä»·`SSVEP`çš„ä¿¡å·è´¨é‡

ä¿¡å™ªæ¯”çš„åŸå§‹å®šä¹‰ï¼šæœ‰ç”¨`**ä¿¡å·åŠŸç‡(Power of Signal)**ä¸**å™ªå£°ä¿¡å·åŠŸç‡(Power of Noise)**çš„æ¯”ï¼Œä¹Ÿå°±æ˜¯***\*å¹…åº¦(Amplitude)å¹³æ–¹\****çš„æ¯”ï¼Œå¦‚ä¸‹æ‰€ç¤º:

![img](https://latex.codecogs.com/gif.latex?%5Clarge%20SNR%20%3D%20%5Cfrac%7BP_%7Bsignal%7D%7D%7BP_%7Bnoise%7D%7D%20%3D%20%5Cfrac%7BA_%7Bsignal%7D%5E%7B2%7D%7D%7BA_%7Bnoise%7D%5E%7B2%7D%7D)

å®ƒçš„å•ä½ä¸€èˆ¬ä½¿ç”¨åˆ†è´ï¼Œå¦‚æœæ¢ç®—ä¸ºåˆ†è´çš„è¯ï¼ŒSNRå°±æ˜¯åå€å¯¹æ•°ä¿¡å·ä¸å™ªå£°åŠŸç‡æ¯”ï¼š

![img](https://latex.codecogs.com/gif.latex?%5Clarge%20SNR%20%3D%2010log_%7B10%7D%5Cleft%20%28%20%5Cfrac%7BP_%7Bsignal%7D%7D%7BP_%7Bnoise%7D%7D%20%5Cright%20%29%20%3D%2010log_%7B10%7D%5Cleft%20%28%20%5Cfrac%7BA_%7Bsignal%7D%5E%7B2%7D%7D%7BA_%7Bnoise%7D%5E%7B2%7D%7D%20%5Cright%20%29%20%3D%2020log_%7B10%7D%5Cleft%20%28%20%5Cfrac%7BA_%7Bsignal%7D%5E%7B%7D%7D%7BA_%7Bnoise%7D%5E%7B%7D%7D%20%5Cright%20%29)

è¿™ä¿©**å…¬å¼è¦åœ¨è®ºæ–‡é‡Œé¢åˆ—å‡º**

å¹¶ä¸”ï¼Œæˆ‘ä»¬å–ä¿¡å™ªæ¯”å®šä¹‰ä¸º**ç»™å®šé¢‘ç‡f**ä¸‹çš„æŒ¯å¹…ä¸ç›¸é‚»**2Hzé¢‘å¸¦**å†…ä¿¡å·å¹³å‡æŒ¯å¹…çš„æ¯”å€¼**[ f - 1   f + 1 ]**

æ‰€ä»¥åœ¨ä»£ç ä¸­çš„å†™æ³•å¦‚ä¸‹ï¼š

```matlab
%% SNR. 1Hz around central frequency, namely, 2048/250=8 points
% ç¿»è¯‘ï¼šä¸­å¿ƒé¢‘ç‡é™„è¿‘1Hzï¼Œå³2048/250=8ç‚¹

%æ‰€ä»¥æµç¨‹å¦‚ä¸‹ï¼š
%1.æˆ‘ä»¬å…³å¿ƒçš„æ˜¯ä¸Šé¢å®šä¹‰çš„æ»¤æ³¢å™¨ä¹‹é—´çš„é¢‘ç‡ï¼Œä¸‹é™æ˜¯7hzï¼Œä¸Šé™æ˜¯70hz
%æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸‹é™é¢‘ç‡ä½ç½®å’Œä¸Šé™é¢‘ç‡ä½ç½®
%ä¸‹é™é¢‘ç‡ä½ç½®çš„å¯»æ‰¾å¹¶æ²¡æœ‰ä»€ä¹ˆå®é™…æ„ä¹‰ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä¸Šé¢çš„ä»£ç ä¸­ç»è¿‡FFTçš„æ•°æ®å¹¶æ²¡æœ‰é€šè¿‡å¸¦é€šæ»¤æ³¢å™¨ï¼Œæ‰€ä»¥ä¸‹é™å°±æ˜¯0
%å¦‚æœæˆ‘ä»¬åœ¨å°†æ¥å¤„ç†é‡‡æ¥çš„é‚£ç§Rawæ•°æ®çš„æ—¶å€™é€šè¿‡äº†å¸¦é€šæ»¤æ³¢å™¨ï¼Œé‚£æ—¶å€™å°±è¦è€ƒè™‘ä¸‹é™é—®é¢˜äº† 
%ä¸Šé™é¢‘ç‡çš„å¯»æ‰¾ï¼šè¿™é‡Œåº”è¯¥æ˜¯å¸Œæœ›å¯»æ‰¾åˆ°70Hzå°±å·²ç»è¶³å¤Ÿäº†ï¼Œä»é¢‘è°±å›¾æ¥çœ‹åé¢çš„å¤šæ¬¡è°æ³¢å·²ç»æ²¡æœ‰å‡¸æ˜¾çš„å³°å€¼äº†
%ä¸Šé™é¢‘ç‡ï¼šf1ä¸­æ˜¯åŒ…å«0~250hzçš„ï¼Œå¹¶ä¸”fftä»¥åæ˜¯2048ä¸ªé‡‡æ ·ç‚¹ï¼Œæ‰€ä»¥å°±ç›¸å½“äºåœ¨AverDataRawä¸­250Hzçš„é¢‘ç‡è¢«åˆ†æˆäº†2048ä»½
%æ‰€ä»¥æ¯1hzçš„é¢‘ç‡åŒ…å«2048/256=8ä¸ªç‚¹ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸Šé¢é‚£å¥è¯çš„æ„ä¹‰
%åœ¨wangé‚£ç¯‡è®ºæ–‡é‡Œé¢æ˜ç¡®æåˆ°äº†ï¼šæœ¬ç ”ç©¶å°†ä¿¡å™ªæ¯”å®šä¹‰ä¸ºç»™å®šé¢‘ç‡fä¸‹çš„æŒ¯å¹…ä¸ç›¸é‚»2Hzé¢‘å¸¦å†…ä¿¡å·å¹³å‡æŒ¯å¹…çš„æ¯”å€¼[f-1 f+1]ã€‚
%æ‰€ä»¥å°±æ˜¯ä¸‹é¢çš„forå¾ªç¯é‡Œé¢åˆ¤æ–­

[~, index] = min(abs(f1-70));
amplitude = AverDataRaw;
SNR=zeros(1, index);
for Nf = 1:index
    if Nf==1%å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªç‚¹çš„è¯ï¼Œæ²¡æœ‰å‰é¢çš„é¢‘ç‡ï¼Œæ‰€ä»¥å°±æ˜¯å¾€åå»¶ä¼¸8ä¸ªç‚¹ï¼Œç›¸å½“äºï¼šç»™å®šé¢‘ç‡fä¸‹çš„æŒ¯å¹…ä¸åé¢1Hzé¢‘å¸¦å†…ä¿¡å·å¹³å‡æŒ¯å¹…çš„æ¯”å€¼[0 0+1]
        coef = amplitude(Nf)/mean(amplitude(Nf:Nf+8));
    elseif Nf>1 && Nf<=8%å¦‚æœæ˜¯åœ¨1~8ä¸ªç‚¹ä¹‹é—´ï¼Œé‚£ä¹ˆSNR=ç»™å®šé¢‘ç‡fä¸‹çš„æŒ¯å¹…ä¸ç¬¬ä¸€ä¸ªç‚¹åˆ°åé¢f+8ä¸ªç‚¹ é¢‘å¸¦å†…ä¿¡å·å¹³å‡æŒ¯å¹…çš„æ¯”å€¼[0 f + 1]
        coef = amplitude(Nf)/mean(amplitude(1:Nf+8));
    elseif Nf>8 && Nf<index-8%ä¸­é—´éƒ¨åˆ†å°±æ˜¯æˆ‘ä»¬å®šä¹‰çš„é‚£ä¸ªäº†
        coef = amplitude(Nf)/mean(amplitude(Nf-8:Nf+8));
    elseif Nf>=index-8 && Nf < index%æœ€åå°äºindexçš„8ä¸ªç‚¹
        coef = amplitude(Nf)/mean(amplitude(Nf-8:index));
    else
         coef = amplitude(Nf)/mean(amplitude(Nf-8:Nf)); 
    end
    SNR(Nf) = 20*log10(coef);
    %å¯¹è„‘ç”µä¿¡å·æ±‚ä¿¡å™ªæ¯”ï¼šæˆ‘ä»¬æ¢ç®—æˆç”µå‹å¹…å€¼çš„æ¯”ç‡å…³ç³»ï¼š20Lg(Vs/Vn)ï¼ŒVså’ŒVnåˆ†åˆ«ä»£è¡¨ä¿¡å·å’Œå™ªå£°ç”µå‹çš„â€œæœ‰æ•ˆå€¼â€ã€‚
    %å…·ä½“å®šä¹‰çœ‹ä¸‹é¢è¿™ä¸ªåšå®¢
end
subplot(313)
plot(f1(1:index), SNR,'linewidth', 1), xlim([5 70])
xlabel('Frequency(Hz)'), ylabel('SNR(dB)')
```

å…³äº`for`å¾ªç¯é‡Œé¢ä¿¡å™ªæ¯”çš„å†™æ³•ï¼Œè®ºæ–‡é‡Œ**åˆ—å‡ºå…¬å¼**

[ä¿¡å™ªæ¯”ï¼ˆSNRæˆ–S/Nï¼‰_sxhpaiçš„åšå®¢-CSDNåšå®¢_ä¿¡å™ªæ¯”](https://blog.csdn.net/weixin_41949409/article/details/120461773?spm=1001.2101.3001.6650.8&utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-8.pc_relevant_antiscanv2&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-8.pc_relevant_antiscanv2&utm_relevant_index=11)

***

### å…³äºæ—¶é¢‘å›¾çš„è¯´æ˜

```matlab
spectrogram(AverDataFilted,hamming(128),127,128,250, 'yaxis'), ylim([0 80]);
axis off;%æ¶ˆé™¤spectrogramç»˜åˆ¶å›¾åƒä¸­çš„åæ ‡è½´æ˜¾ç¤º
colorbar('delete')%å»æ‰spectrogramè‡ªå¸¦çš„colorbaræ˜¾ç¤º
```

å…³äº`spectrogram`ï¼Œæ›´å¤šçš„å»çœ‹ğŸ‘‰ğŸ‘‰ğŸ‘‰[spectrogramå‡½æ•°åšçŸ­æ—¶å‚…é‡Œå¶åˆ†æ - å¹³å¸¸å¿ƒï¼Œå¹³å¸¸å¿ƒ - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/shuqingstudy/p/10207354.html)

